* 我们陆续介绍了 Redis用到的所有主要数据结构，比如简单动态字符串（SDS）、双端链表、字典、压缩列表、整数集合等等。
* Redis并没有直接使用这些数据结构来实现键值对数据库，而是基于这些数据结构创建了一个对象系统，这个系统包含字符串对象、列表对象、哈希对象、集合对象和有序集合对象这五种类型的对象，每种对象都用到了至少一种我们前面所介绍的数据结构。
* 通过这五种不同类型的对象，Redis可以在执行命令之前，根据对象的类型来判断一个对象是否可以执行给定的命令。使用对象的另一个好处是，我们可以针对不同的使用场景， 为对象设置多种不同的数据结构实现，从而优化对象在不同场景下的使用效率。
* 除此之外，Redis的对象系统还实现了基于引用计数技术的内存回收机制，当程序不再 使用某个对象的时候，这个对象所占用的内存就会被自动释放；另外，Redis还通过引用计 数技术实现了对象共享机制，这一机制可以在适当的条件下，通过让多个数据库键共享同一个对象来节约内存。
* 最后，Redis的对象带有访问时间记录信息，该信息可以用于计算数据库键的空转时长，在服务器启用了maxmemory功能的情况下，空转时长较大的那些键可能会优先被服务器删除。

#### 对象的类型与编码

* Redis使用对象来表示数据库中的键和值，每次当我们在Redis的数据库中新创建一个键值对时，我们至少会创建两个对象，一个对象用作键值对的键（键对象），另一个对象用作键值对的值（值对象）

* 举个例子，以下SET命令在数据库中创建了一个新的键值对，其中键值对的键是一个包含了字符串值"msg"的对象，而键值对的值则是一个包含了字符串值"hello world" 的对象：`SET msg "hello world`

* Redis中的每个对象都由一个redisObject结构表示，该结构中和保存数据有关的三个属性分别是type属性、encoding属性和ptr属性：

  ```c++
  typedef struct redisObject (
  
    //类型
    unsigned type:4;
  
    //编码
    unsigned encoding:4;
  
    //指向底层实现数据结构的指针
    void *ptr;
  
  } robj;
  ```

##### 类型

* 对象的type属性记录了对象的类型，这个属性的值可以是下表列出的常量的其中一个。

  | 类型常量     | 对象的名称   |
  | ------------ | ------------ |
  | REDIS_STRING | 字符串对象   |
  | REDIS_LIST   | 列表对象     |
  | REDIS_HASH   | 哈希对象     |
  | REDIS_SET    | 集合对象     |
  | REDIS_ZSET   | 有序集合对象 |

* 对于Redis数据库保存的键值对来说，键总是一个字符串对象，而值则可以是字符串对象、列表对 象、哈希对象、集合对象或者有序集合对象的其中 一种，因此：

  * 当我们称呼一个数据库键为“字符串键”时， 我们指的是“这个数据库键所对应的值为字 符串对象”；
  * 当我们称呼一个键为“列表键”时，我们指的是“这个数据库键所对应的值为列表 对象”。

* TYPE 命令的实现方式也与此类似，当我们对一个数据库键执行 TYPE 命令时，命令返回的结果为数据库键对应的值对象的类型，而不是键对象的类型

* 不同类型值对象的 TYPE 命令输出

  | 对象         | 对象type属性的值 | TYPE命令的输出 |
  | ------------ | ---------------- | -------------- |
  | 字符串对象   | REDIS_STRING     | string         |
  | 列表对象     | REDIS_LIST       | list           |
  | 哈希对象     | REDIS_HASH       | hash           |
  | 集合对象     | REDIS_SET        | set            |
  | 有序集合对象 | REDIS_ZSET       | zset           |

##### 编码和底层实现

* 对象的ptr指针指向对象的底层实现数据结构，而这些数据结构由对象的 encoding 属性决定。

* encoding属性记录了对象所使用的编码，也即是说这个对象使用了什么数据结构作为对象的底层实现。

* 对象的编码

  | 编码常量                  | 编码所对应的底层数据结构   |
  | ------------------------- | -------------------------- |
  | REDIS_ENCODING_INT        | long类型的整数             |
  | REDIS_ENCODING EMBSTR     | embstr编码的简单动态字符串 |
  | REDIS_ENCODING_RAW        | 简单动态字符串             |
  | REDIS_ENCODING_HT         | 字典                       |
  | REDIS_ENCODING_LINKEDLIST | 双端链表                   |
  | REDIS_ENCODING_ZIPLIST    | 压缩列表                   |
  | REDIS_ENCODING_INTSET     | 整数集合                   |
  | REDIS_ENCODING_SKIPLIST   | 跳跃表和字典               |

* 每种类型的对象都至少使用了两种不同的编码

* 不同类型和编码的对象

  | 类型         | 编码                      | 对象                                           |
  | ------------ | ------------------------- | ---------------------------------------------- |
  | REDIS_STRING | REDIS_ENCODING_INT        | 使用整数值实现的字符串对象                     |
  | REDIS_STRING | REDIS_ENCODING_EMBSTR     | 使用embstr编码的简单动态字符串实现的字符串对象 |
  | REDIS_STRING | REDIS_ENCODING_RAW        | 使用简单动态字符串实现的字符串对象             |
  | REDIS_LIST   | REDIS_ENCODING_ZIPLIST    | 使用压缩列表实现的列表对象                     |
  | REDIS_LIST   | REDIS_ENCODING_LINKEDLIST | 使用双端链表实现的列表对象                     |
  | REDIS_HASH   | REDIS_ENCODING_ZIPLIST    | 使用压缩列表实现的哈希对象                     |
  | REDIS_HASH   | REDIS_ENCODING_HT         | 使用字典实现的哈希对象                         |
  | REDIS_SET    | REDIS_ENCODING_INTSET     | 使用整数集合实现的集合对象                     |
  | REDIS_SET    | REDIS_ENCODING_HT         | 使用字典实现的集合对象                         |
  | REDIS_ZSET   | REDIS_ENCODING_ZIPLIST    | 使用压缩列表实现的有序集合对象                 |
  | REDIS ZSET   | REDIS_ENCODING SKIPLIST   | 使用跳跃表和字典实现的有序集合对象             |

* 使用 OBJECT ENCODING 命令可以查看一个数据库键的值对象的编码

* OBJECT ENCODING 对不同编码的输出

  | 对象所使用的底层数据结构        | 编码常量                  | OBJECT ENCODING 命令輸出 |
  | ------------------------------- | ------------------------- | ------------------------ |
  | 整数                            | REDIS_ENCODING_INT        | int                      |
  | embstr编码的简单动态字符串(SDS) | REDIS_ENCODING_EMBSTR     | embstr                   |
  | 简单动态字符串                  | REDIS ENCODING RAW        | raw                      |
  | 字典                            | REDIS ENCODING HT         | hashtable                |
  | 双端链表                        | REDIS_ENCODING_LINKEDLIST | linkedlist               |
  | 压缩列表                        | REDIS_ENCODING_ZIPLIST    | ziplisf                  |
  | 整数集合                        | REDIS_ENCODING_INTSET     | intset                   |
  | 跳跃表和字典                    | REDIS_ENCODING_SKIPLIST   | skiplist                 |

* 通过encoding属性来设定对象所使用的编码，而不是为特定类型的对象关联一种固 定的编码，极大地提升了 Redis的灵活性和效率，因为Redis可以根据不同的使用场景来为 一个对象设置不同的编码，从而优化对象在某一场景下的效率。
* 举个例子，在列表对象包含的元素比较少时，Redis使用压缩列表作为列表对象的底层实现：
  * 因为压缩列表比双端链表更节约内存，并且在元素数量较少时，在内存中以连续块方式保存的压缩列表比起双端链表可以更快被载入到缓存中；
  * 随着列表对象包含的元素越来越多，使用压缩列表来保存元素的优势逐渐消失时，对象就会将底层实现从压缩列表转向功能更强、也更适合保存大量元素的双端链表上面； 其他类型的对象也会通过使用多种不同的编码来进行类似的优化。
  * 在接下来的内容中，我们将分别介绍Redis中的五种不同类型的对象，说明这些对象底层所使用的编码方式，列出对象从一种编码转换成另一种编码所需的条件，以及同一个命令在多种不同编码上的实现方法。

#### 字符串对象

* 字符串对象的编码可以是int、raw或者embstr

* 如果一个字符串对象保存的是整数值，并且这个整数值可以用long类型来表示，那么字符串对象会将整数值保存在字符串对象结构的ptr属性里面（将void*转换成long ）, 并将字符串对象的编码设置为int

* 举个例子，如果我们执行以下SET命令，那么服务器将创建一个in t编码的字符串对象作为 number键的值：

  ```
  redis> SET number 10086
  OK
  redis> OBJECT ENCODING number "int*
  ```

* 如果字符串对象保存的是一个字符串值，并且这个字符串值的长度大于32字节，那么字符串对象将使用一个简单动态字符串（SDS）来保存这个字符串值，并将对象的编码设置 为 raw
* 如果字符串对象保存的是一个字符串值，并且这个字符串值的长度小于等于32字节, 那么字符串对象将使用embstr编码的方式来保存这个字符串值。
* embstr编码是专门用于保存短字符串的一种优化编码方式，这种编码和raw编码一 样，都使用redisObject结构和sdshdr结构来表示字符串对象，但raw编码会调用两 次内存分配函数来分别创建redisObject结构和sdshdr结构，而embstr编码则通过 调用一次内存分配函数来分配一块连续的空间，空间中依次包含redisObject和sdshdr 两个结构

* embstr编码的字符串对象在执行命令时，产生的效果和raw编码的字符串对象执行命令时产生的效果是相同的，但使用embstr编码的字符串对象来保存短字符串值有以下好处：
  * embstr编码将创建字符串对象所需的内存分配次数从raw编码的两次降低为一次。
  * 释放embstr编码的字符串对象只需要调用一次内存释放函数，而释放raw编码的字符串对象需要调用两次内存释放函数。
  * 因为embstr编码的字符串对象的所有数据都保存在一块连续的内存里面，所以这种编码的字符串对象比起raw编码的字符串对象能够更好地利用缓存带来的优势。
* 最后要说的是，可以用long double类型表示的浮点数在Redis中也是作为字符串值来保存的。如果我们要保存一个浮点数到字符串对象里面，那么程序会先将这个浮点数转换成字符串值，然后再保存转换所得的字符串值。
* 在有需要的时候，程序会将保存在字符串对象里面的字符串值转换回浮点数值，执行某些操作，然后再将执行操作所得的浮点数值转换回字符串值，并继续保存在字符串对象 里面。

